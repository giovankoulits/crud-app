<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register and Login</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles/style.css" />
  </head>
  <body>
    <section>
      <form action="/#" id="regForm" method="POST" autocomplete="off">
        <legend>
          <fieldset>Register</fieldset>
          <div class="formBox">
            <label for="email">Email</label
            ><input class="email" type="email" autocomplete="off" />
          </div>
          <div class="formBox">
            <label for="pass">Password</label
            ><input class="password" type="password" autocomplete="off" />
          </div>
          <div class="formBox"><button>Register</button></div>
        </legend>
      </form>
    </section>
    <section>
      <form action="/#" id="loginForm" method="POST" autocomplete="off">
        <legend>
          <fieldset>Login</fieldset>
          <div class="formBox">
            <label for="email">Email</label
            ><input class="email" type="email" autocomplete="off" />
          </div>
          <div class="formBox">
            <label for="pass">Password</label
            ><input class="password" type="password" autocomplete="off" />
          </div>
          <div class="formBox"><button>Login</button></div>
        </legend>
      </form>
    </section>
    <script defer>
      //process the login and the register
      document
        .querySelector("#regForm button")
        .addEventListener("click", doRegister);

      document
        .querySelector("#loginForm button")
        .addEventListener("click", doLogin);

      function doRegister(event) {
        event.preventDefault();
        const email = document.querySelector("#regForm .email").value;
        const password = document.querySelector("#regForm .password").value;
        const user = { email, password };
        sendData(user, "register", registerSuccess);
      }

      function doLogin(event) {
        event.preventDefault();
        const email = document.querySelector("#loginForm .email").value;
        const password = document.querySelector("#loginForm .password").value;
        const user = { email, password };
        sendData(user, "login", loginSuccess);
      }

      function sendData(user, endpoint, callback) {
        if (endpoint === "register" || endpoint === "login") {
          let url = `http://localhost:3000/${endpoint}`;
          const myHeaders = new Headers();
          myHeaders.append("Content-Type", "application/json");
          const request = new Request(url, {
            method: "POST",
            headers: myHeaders,
            body: JSON.stringify(user),
          });
          fetch(request)
            .then((res) => res.json())
            .then((content) => {
              if ("error" in content) {
                failure(content.error);
              }
              if ("data" in content) {
                callback(content.data);
              }
            })
            .catch(failure);
        }
      }

      function loginSuccess(data) {
        //we have a token so put it in localstorage
        console.log("token", data.token);
        sessionStorage.setItem("myapp-token", data.token);
        alert("You are logged in");
      }

      function registerSuccess(data) {
        //user has been registered
        console.log("new user created", data);
        alert("You have been registered");
      }

      function failure(err) {
        alert(err.message);
        console.log(err.code, err.message);
      }
    </script>
  </body>
</html>
